<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES æ™ºæ…§æˆ°æƒ…å®¤</title>
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --repair: #3b82f6; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        
        /* æ¨™é¡Œèˆ‡ç™»å‡ºæŒ‰éˆ•å€å¡Š */
        .header-bar { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 30px auto; }
        h1 { margin: 0; font-weight: 800; color: #111827; flex-grow: 1; text-align: center; }
        .btn-logout { background-color: #9ca3af; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; display: none; } /* é è¨­éš±è— */
        .btn-logout:hover { background-color: #6b7280; }

        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .section-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--primary); padding-left: 10px; }

        /* æ©Ÿå°åˆ—è¡¨ */
        .machine-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .machine-card { 
            text-align: center; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .machine-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
        .machine-card::after { content: 'ğŸ‘† é»æ“Šæ“ä½œ'; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.05); font-size: 0.8rem; color: #666; padding: 2px 0; opacity: 0; transition: opacity 0.2s; }
        .machine-card:hover::after { opacity: 1; }

        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 99px; font-size: 0.875rem; font-weight: 600; margin-top: 10px; color: white;}
        .status-0 { background-color: var(--warning); } /* Idle */
        .status-1 { background-color: var(--success); } /* Running */
        .status-2 { background-color: var(--danger); }  /* Down */
        .status-3 { background-color: var(--repair); }  /* Repair */

        /* æ¨¡æ…‹è¦–çª— (Modal) å…±ç”¨æ¨£å¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal h3 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #e5e7eb; color: #374151; }
        .btn-submit { background: var(--primary); color: white; width: 100%; } /* Login button width */
        .btn-submit:hover { opacity: 0.9; }
        .btn-action-submit { background: var(--primary); color: white; } /* Action modal button */

        /* å…¶ä»–åŸæœ‰æ¨£å¼ (å·¥å–®/WIP) */
        .wo-list { display: flex; flex-direction: column; gap: 10px; }
        .wo-item { border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .progress-bg { background-color: #e5e7eb; border-radius: 99px; height: 10px; width: 100%; margin-top: 5px; overflow: hidden; }
        .progress-bar { background-color: var(--primary); height: 100%; transition: width 0.5s ease; }
        .wip-chart { display: flex; align-items: flex-end; gap: 20px; height: 150px; padding-top: 20px; border-bottom: 2px solid #ccc;}
        .bar-container { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; }
        .bar { background-color: var(--warning); width: 60%; margin: 0 auto; border-radius: 5px 5px 0 0; transition: height 0.5s; min-height: 2px; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h1>ğŸ­ MES æ™ºæ…§è£½é€ æˆ°æƒ…å®¤</h1>
        <button id="logoutBtn" class="btn-logout" onclick="performLogout()">ç™»å‡º (Logout)</button>
    </div>

    <div class="container" id="dashboardContent" style="display:none; filter: blur(5px);">
        <div class="card">
            <div class="section-title">è¨­å‚™ç‹€æ…‹ç›£æ§ (é»æ“Šå¯æ“ä½œ)</div>
            <div id="machine-container" class="machine-grid">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card">
            <div class="section-title">ç”Ÿç”¢å·¥å–®é€²åº¦</div>
            <div id="wo-container" class="wo-list">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card">
            <div class="section-title">ç”¢ç·šåœ¨è£½å“å †ç©</div>
            <div id="wip-container" class="wip-chart">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay" style="display: flex;">
        <div class="modal">
            <h3>ğŸ” è«‹ç™»å…¥ MES ç³»çµ±</h3>
            <div class="form-group">
                <label>å¸³è™Ÿ (Username)</label>
                <input type="text" id="loginUser" value="admin" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼ (Password)</label>
                <input type="password" id="loginPass" value="admin123" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <div class="btn-group">
                <button class="btn-submit" onclick="performLogin()">ç™»å…¥ (Login)</button>
            </div>
            <p id="loginError" style="color:red; text-align:center; margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="actionModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">è¨­å‚™æ“ä½œ</h3>
            <div id="modalContent"></div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-action-submit" onclick="submitAction()">ç¢ºå®šåŸ·è¡Œ</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5289/api';
        
        // å¾ LocalStorage å˜—è©¦å–å¾— Token
        let jwtToken = localStorage.getItem('mes_token');
        let refreshInterval = null;

        // ç•¶å‰æ“ä½œçš„æ©Ÿå°è³‡æ–™
        let currentMachine = null;

        // åˆå§‹åŒ–æª¢æŸ¥
        checkLoginStatus();

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkLoginStatus() {
            if (jwtToken) {
                // å·²ç™»å…¥
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'grid';
                document.getElementById('dashboardContent').style.filter = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                
                // å•Ÿå‹•è‡ªå‹•æ›´æ–°
                fetchData();
                if (!refreshInterval) {
                    refreshInterval = setInterval(fetchData, 5000);
                }
            } else {
                // æœªç™»å…¥
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('dashboardContent').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
        }

        // åŸ·è¡Œç™»å…¥
        async function performLogin() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            // æŒ‰éˆ• Loading ç‹€æ…‹
            const btn = document.querySelector('.btn-submit');
            const originalText = btn.innerText;
            btn.innerText = "é©—è­‰ä¸­...";
            btn.disabled = true;

            try {
                const res = await fetch(`${BASE_URL}/Auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (res.ok) {
                    const data = await res.json();
                    jwtToken = data.token;
                    // å„²å­˜ Token åˆ° LocalStorage (é™¤éç™»å‡ºï¼Œå¦å‰‡é‡æ•´ä¸ç”¨é‡ç™»)
                    localStorage.setItem('mes_token', jwtToken);
                    errorMsg.innerText = "";
                    checkLoginStatus();
                } else {
                    errorMsg.innerText = "ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                }
            } catch (e) {
                errorMsg.innerText = "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å•Ÿå‹•";
                console.error(e);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // åŸ·è¡Œç™»å‡º
        function performLogout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ")) {
                localStorage.removeItem('mes_token');
                jwtToken = null;
                checkLoginStatus();
            }
        }

        // ç²å–æ•¸æ“š (å¸¶å…¥ JWT Token)
        async function fetchData() {
            if (!jwtToken) return;

            try {
                // [Day 16] è¨­å®š Header å¸¶å…¥ Token
                const headers = { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                };

                const [eqRes, woRes, wipRes] = await Promise.all([
                    fetch(`${BASE_URL}/Equipment`, { headers }),
                    fetch(`${BASE_URL}/WorkOrder`, { headers }),
                    fetch(`${BASE_URL}/Production/wip`, { headers })
                ]);
                
                // è™•ç† Token éæœŸæˆ–ç„¡æ•ˆ
                if (eqRes.status === 401) {
                    alert('ç™»å…¥å·²é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥');
                    performLogout(); // å¼·åˆ¶ç™»å‡º
                    return;
                }

                renderMachines(await eqRes.json());
                renderWorkOrders(await woRes.json());
                renderWip(await wipRes.json());
            } catch (error) { console.error("Fetch Error:", error); }
        }

        // æ¸²æŸ“æ©Ÿå°
        function renderMachines(data) {
            const container = document.getElementById('machine-container');
            const statusText = { 0: 'é–’ç½® Idle', 1: 'é‹ä½œ Running', 2: 'æ•…éšœ Down', 3: 'ç¶­ä¿® Repair' };
            
            container.innerHTML = data.map(eq => `
                <div class="machine-card" onclick='openActionModal(${JSON.stringify(eq)})'>
                    <div style="font-weight:bold; font-size:1.1rem;">${eq.name}</div>
                    <div style="font-size:0.9rem; color:#666; margin:5px 0;">${eq.location}</div>
                    <div class="status-badge status-${eq.status}">
                        ${statusText[eq.status] || 'Unknown'}
                    </div>
                </div>
            `).join('');
        }

        // é–‹å•Ÿæ“ä½œè¦–çª—
        function openActionModal(eq) {
            currentMachine = eq;
            const modal = document.getElementById('actionModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            modal.style.display = 'flex';
            title.innerText = `æ“ä½œè¨­å‚™: ${eq.name}`;

            if (eq.status === 1 || eq.status === 0) { 
                content.innerHTML = `
                    <p>ç›®å‰ç‹€æ…‹æ­£å¸¸ã€‚æ˜¯å¦è¦å›å ±ç•°å¸¸ï¼Ÿ</p>
                    <div class="form-group">
                        <label>ç•°å¸¸ä»£ç¢¼</label>
                        <input type="text" id="inputReason" value="ERR-001">
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <textarea id="inputDesc">é‹è½‰ç•°éŸ³</textarea>
                    </div>
                    <input type="hidden" id="actionType" value="REPORT">
                `;
            } else if (eq.status === 2) {
                content.innerHTML = `
                    <p style="color:red; font-weight:bold;">è¨­å‚™æ•…éšœä¸­ï¼</p>
                    <p>è¦é–‹å§‹ç¶­ä¿®å—ï¼Ÿ</p>
                    <div class="form-group">
                        <label>ç¶­ä¿®å–® ID</label>
                        <input type="number" id="inputRequestId" placeholder="è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ">
                    </div>
                    <input type="hidden" id="actionType" value="START">
                `;
            } else if (eq.status === 3) {
                content.innerHTML = `
                    <p style="color:blue; font-weight:bold;">è¨­å‚™ç¶­ä¿®ä¸­...</p>
                    <div class="form-group">
                        <label>ç¶­ä¿®å–® ID</label>
                        <input type="number" id="inputRequestId" placeholder="è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label>è™•ç½®å°ç­–</label>
                        <textarea id="inputSolution">æ›´æ›é›¶ä»¶</textarea>
                    </div>
                    <input type="hidden" id="actionType" value="COMPLETE">
                `;
            }
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        // é€å‡ºè¡¨å–® (å¸¶å…¥ JWT Token)
        async function submitAction() {
            const type = document.getElementById('actionType').value;
            let url = '', method = '', body = {};

            try {
                if (type === 'REPORT') {
                    url = `${BASE_URL}/Maintenance/request`;
                    method = 'POST';
                    body = {
                        equipmentId: currentMachine.id,
                        requestUser: "Dashboard User",
                        reasonCode: document.getElementById('inputReason').value,
                        description: document.getElementById('inputDesc').value
                    };
                } else if (type === 'START') {
                    const reqId = document.getElementById('inputRequestId').value;
                    if(!reqId) return alert('è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ');
                    url = `${BASE_URL}/Maintenance/${reqId}/start`;
                    method = 'PATCH';
                } else if (type === 'COMPLETE') {
                    const reqId = document.getElementById('inputRequestId').value;
                    if(!reqId) return alert('è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ');
                    url = `${BASE_URL}/Maintenance/complete`;
                    method = 'POST';
                    body = {
                        requestId: reqId,
                        solution: document.getElementById('inputSolution').value,
                        remark: "Dashboard Completed"
                    };
                }

                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}` // [Day 16] Header
                    },
                    body: method === 'POST' ? JSON.stringify(body) : null
                });

                if (res.ok) {
                    alert('æ“ä½œæˆåŠŸï¼');
                    closeModal();
                    fetchData();
                } else {
                    const err = await res.json();
                    alert('å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
                }

            } catch (e) {
                alert('é€£ç·šéŒ¯èª¤');
                console.error(e);
            }
        }

        // æ¸²æŸ“å·¥å–®
        function renderWorkOrders(data) {
             const container = document.getElementById('wo-container');
            const activeOrders = data.filter(o => o.status !== 'Completed');
            if (activeOrders.length === 0) {
                container.innerHTML = '<div style="color:#666;">ç›®å‰ç„¡ç”Ÿç”¢ä¸­å·¥å–®</div>';
                return;
            }
            container.innerHTML = activeOrders.map(wo => {
                const percent = wo.targetQty > 0 ? Math.min(100, Math.round((wo.currentQty / wo.targetQty) * 100)) : 0;
                return `
                <div class="wo-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>${wo.orderNo} (${wo.product})</strong>
                        <span>${wo.currentQty} / ${wo.targetQty} (${wo.status})</span>
                    </div>
                    <div class="progress-bg"><div class="progress-bar" style="width: ${percent}%"></div></div>
                </div>`}).join('');
        }
        
        // æ¸²æŸ“ WIP
        function renderWip(data) {
            const container = document.getElementById('wip-container');
            const stationMap = {};
            data.forEach(w => { const name = w.stationName || `Station ${w.stationId}`; stationMap[name] = (stationMap[name] || 0) + w.quantity; });
            const html = Object.keys(stationMap).map(stationName => {
                const qty = stationMap[stationName];
                const heightPercent = Math.min(100, (qty / 500) * 100); 
                return `<div class="bar-container"><div class="bar-value">${qty}</div><div class="bar" style="height: ${heightPercent}%;"></div><div class="bar-label">${stationName}</div></div>`;
            }).join('');
            container.innerHTML = html || '<div style="width:100%; text-align:center;">å°šç„¡ WIP è³‡æ–™</div>';
        }
    </script>
</body>
</html>