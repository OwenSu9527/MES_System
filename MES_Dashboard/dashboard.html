<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES 整合製造執行系統 | Enterprise Edition</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- 1. CSS 變數系統 --- */
        :root {
            --primary: #2563eb; --primary-hover: #1d4ed8;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --repair: #8b5cf6;
            --bg-body: #f1f5f9; --bg-sidebar: #ffffff; --bg-card: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b; --border-color: #e2e8f0;
            --sidebar-active: #eff6ff; --sidebar-hover: #f8fafc;
            --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --chart-text: #64748b; --chart-grid: #e2e8f0;
            --table-hover: #f8fafc;
            --modal-overlay: rgba(0,0,0,0.5);
        }

        [data-theme="dark"] {
            --primary: #3b82f6; --primary-hover: #60a5fa;
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --bg-card: #1e293b;
            --text-main: #f8fafc; --text-sub: #94a3b8; --border-color: #334155;
            --sidebar-active: #334155; --sidebar-hover: #2a384b;
            --shadow-card: none;
            --chart-text: #94a3b8; --chart-grid: #334155;
            --table-hover: #2d3748;
            --modal-overlay: rgba(0,0,0,0.7);
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }

        /* --- Utility Classes (取代 Inline Styles) --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; } .gap-3 { gap: 12px; } .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .text-sm { font-size: 0.85rem; }
        .text-sub { color: var(--text-sub); }
        .font-bold { font-weight: 700; }
        .cursor-pointer { cursor: pointer; }
        .hidden { display: none !important; }

        /* --- Layout --- */
        .app-wrapper { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; transition: transform 0.3s ease; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .app-brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.25rem; margin-bottom: 20px; color: var(--primary); }
        
        .site-selector { background: var(--bg-body); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
        .selector-label { font-size: 0.75rem; color: var(--text-sub); font-weight: bold; margin-bottom: 4px; display: block; text-transform: uppercase; }
        .selector-input { width: 100%; background: var(--bg-card); /* 修改：給予明確背景色，而非 transparent */border: 1px solid var(--border-color); /* 新增：增加邊框讓它更明顯 */border-radius: 6px; /* 新增：圓角 */font-weight: 600; color: var(--text-main); outline: none; cursor: pointer; padding: 6px 8px; /* 修改：增加內距 */margin-top: 4px; }
        .divider { height: 1px; background: var(--border-color); margin: 8px 0; }

        .nav-menu { flex: 1; padding: 20px 10px; list-style: none; margin: 0; overflow-y: auto; }
        .nav-category { font-size: 0.75rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin: 20px 0 8px 15px; letter-spacing: 0.5px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 4px; border-radius: 8px; color: var(--text-sub); cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .nav-item:hover { background-color: var(--sidebar-hover); color: var(--text-main); }
        .nav-item.active { background-color: var(--sidebar-active); color: var(--primary); }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-color); }

		/* --- 請在 CSS 任意處新增此段 (專門修復下拉選單選項顏色) --- */
		select option {
			background-color: var(--bg-card);
			color: var(--text-main);
		}
		/* --- (選用) 優化右側內容區的輸入框顯示 --- */
		.form-control {
			width: 100%;
			padding: 10px 12px;
			background-color: var(--bg-body); /* 確保這裡使用變數 */
			color: var(--text-main);
			border: 1px solid var(--border-color);
			border-radius: 8px;
			font-size: 0.95rem;
			transition: border 0.2s, background-color 0.3s, color 0.3s; /* 增加過渡效果 */
		}

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .page-section { display: none; animation: fadeIn 0.3s ease-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Grid */
        .container-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-card); border: 1px solid var(--border-color); transition: transform 0.2s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .col-span-12 { grid-column: span 12; } .col-span-6 { grid-column: span 6; }
        @media (max-width: 1024px) { .col-span-6 { grid-column: span 12; } }

        /* Machine Grid */
        .machine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .machine-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; text-align: center; position: relative; overflow: hidden; border-top-width: 4px; }
        .machine-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .machine-name { font-weight: 700; margin: 12px 0; font-size: 1.1rem; }
        .machine-val { font-size: 0.9rem; color: var(--text-sub); margin-top: 5px; }
        
        /* Status Badges */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; letter-spacing: 0.5px; }
        .badge-new { background: rgba(37, 99, 235, 0.1); color: #3b82f6; }
        .badge-wip { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .badge-done { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .badge-alert { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .badge-gray { background: rgba(100, 116, 139, 0.1); color: var(--text-sub); border: 1px solid var(--border-color); }

        /* Tables */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-card); }
        .data-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .data-table th { text-align: left; padding: 16px; border-bottom: 2px solid var(--border-color); color: var(--text-sub); font-size: 0.85rem; font-weight: 700; background: var(--bg-card); text-transform: uppercase; }
        .data-table td { padding: 16px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .data-table tr:hover { background-color: var(--table-hover); }

        /* Forms & Inputs */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
        .form-control { width: 100%; padding: 10px 12px; background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; transition: border 0.2s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        
        /* Buttons */
        .btn { padding: 9px 18px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--text-sub); }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        .btn-ghost:hover { background: var(--table-hover); color: var(--text-main); }
        .btn-icon { padding: 8px; font-size: 1.1rem; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; inset: 0; background: var(--modal-overlay); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(2px); animation: fadeIn 0.2s; }
        .modal { background: var(--bg-card); color: var(--text-main); border-radius: 16px; width: 95%; max-width: 700px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; flex-direction: column; max-height: 90vh; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; overflow-y: auto; background: var(--bg-body); }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg-card); border-radius: 0 0 16px 16px; }

        /* Tabs inside Modal */
        .modal-tabs { display: flex; padding: 0 24px; background: var(--bg-body); border-bottom: 1px solid var(--border-color); }
        .modal-tab { padding: 16px 20px; cursor: pointer; color: var(--text-sub); font-weight: 600; border-bottom: 2px solid transparent; transition: 0.2s; }
        .modal-tab:hover { color: var(--primary); }
        .modal-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--bg-card); border-radius: 8px 8px 0 0; border: 1px solid var(--border-color); border-bottom: none; position: relative; top: 1px; }
        .tab-content { display: none; } .tab-content.active { display: block; }

        /* Specific Components */
        .control-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .btn-ctrl { padding: 20px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-ctrl i { font-size: 1.5rem; margin-bottom: 4px; }
        .btn-start { background: rgba(16, 185, 129, 0.1); color: #10b981; } .btn-start:hover{background:#10b981; color:white;}
        .btn-stop { background: rgba(239, 68, 68, 0.1); color: #ef4444; } .btn-stop:hover{background:#ef4444; color:white;}
        .btn-reset { background: rgba(245, 158, 11, 0.1); color: #f59e0b; } .btn-reset:hover{background:#f59e0b; color:white;}

        /* FAI Styles */
        .fai-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px; transition: 0.2s; }
        .fai-card.error { border-color: var(--danger); box-shadow: 0 0 0 2px rgba(239,68,68,0.1); }
        .fai-header { display: flex; justify-content: space-between; align-items: center; }
        .toggle-btn { padding: 6px 16px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; background: var(--bg-body); color: var(--text-sub); transition: 0.2s; font-weight: 600; }
        .toggle-btn.pass.active { background: var(--success); color: white; border-color: var(--success); }
        .toggle-btn.fail.active { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* Mobile Responsive */
        .mobile-header { display: none; padding: 15px 20px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border-color); justify-content: space-between; align-items: center; z-index: 60; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; backdrop-filter: blur(2px); }
        .sidebar-overlay.show { display: block; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100vh; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .main-content { padding: 15px; padding-bottom: 80px; } /* Space for mobile nav if needed */
        }
        
        /* Loading Skeleton */
        .skeleton { background: #e2e8f0; border-radius: 4px; animation: pulse 1.5s infinite ease-in-out; }
        [data-theme="dark"] .skeleton { background: #334155; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    </style>
</head>
<body>

    <div class="mobile-header">
        <div class="flex items-center gap-3">
            <button onclick="App.toggleSidebar()" class="btn-icon" style="background:none; border:none; color:var(--text-main);"><i class="fa-solid fa-bars"></i></button>
            <span class="font-bold text-main" style="font-size:1.2rem;">MES Pro</span>
        </div>
        <i class="fa-solid fa-industry" style="color:var(--primary); font-size:1.5rem;"></i>
    </div>

    <div class="app-wrapper">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="App.toggleSidebar()"></div>

        <aside class="sidebar" id="appSidebar">
            <div class="sidebar-header">
                <div class="app-brand">
                    <i class="fa-solid fa-industry"></i>
                    <div>MES 戰情室</div>
                </div>
                
                <div class="site-selector">
                    <label class="selector-label">廠區 (Plant)</label>
                    <select class="selector-input" id="plantSelect" onchange="App.updateContext()">
                        <option value="P1">新竹廠 (Plant A)</option>
                        <option value="P2">台南廠 (Plant B)</option>
                    </select>
                    <div class="divider"></div>
                    <label class="selector-label">產線 (Line)</label>
                    <select class="selector-input" id="lineSelect" onchange="App.updateContext()">
                        <option value="L1">SMT Line 01</option>
                        <option value="L2">DIP Line 01</option>
                        <option value="L3">Packing Line</option>
                    </select>
                </div>
            </div>

            <ul class="nav-menu">
                <div class="nav-category">監控中心</div>
                <li class="nav-item active" onclick="App.switchPage('dashboard', this)">
                    <i class="fa-solid fa-chart-line w-6"></i> 總覽儀表板
                </li>
                
                <div class="nav-category">生產管理</div>
                <li class="nav-item" onclick="App.switchPage('work-orders', this)">
                    <i class="fa-solid fa-clipboard-list w-6"></i> 工單管理 (ERP)
                </li>
                <li class="nav-item" onclick="App.switchPage('fai-system', this)">
                    <i class="fa-solid fa-microscope w-6"></i> 首件檢查 (FAI)
                </li>
                <li class="nav-item" onclick="App.switchPage('inventory', this)">
                    <i class="fa-solid fa-boxes-stacked w-6"></i> 物料與倉庫
                </li>

                <div class="nav-category">工程配置</div>
                <li class="nav-item" onclick="App.switchPage('engineering', this)">
                    <i class="fa-solid fa-code-branch w-6"></i> 工藝路徑設定
                </li>
            </ul>

            <div class="sidebar-footer">
                <button class="btn btn-outline w-full mb-3" onclick="App.toggleTheme()">
                    <i class="fa-solid fa-moon" id="themeIcon"></i> 深色模式
                </button>
                <button id="logoutBtn" onclick="App.logout()" class="btn w-full hidden" style="border-color:var(--danger); color:var(--danger); background: transparent; border:1px solid;">
                    <i class="fa-solid fa-right-from-bracket"></i> 登出系統
                </button>
            </div>
        </aside>

        <main class="main-content" id="mainContent">
            
            <div id="dashboard" class="page-section active">
                <div class="container-grid">
                    <div class="card col-span-12">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fa-solid fa-server text-primary"></i> 
                                <span id="dashboard-title">新竹廠 - SMT Line 01 設備監控</span>
                            </div>
                            <span class="badge badge-gray"><i class="fa-solid fa-shield-halved"></i> 安全模式啟用</span>
                        </div>
                        <div id="machine-container" class="machine-grid">
                            <div class="skeleton" style="height:150px;"></div>
                            <div class="skeleton" style="height:150px;"></div>
                            <div class="skeleton" style="height:150px;"></div>
                            <div class="skeleton" style="height:150px;"></div>
                        </div>
                    </div>
                    
                    <div class="card col-span-6">
                        <div class="card-title mb-4"><i class="fa-solid fa-chart-column"></i> WIP 在製品分析</div>
                        <div style="height: 250px; position: relative;"><canvas id="wipChart"></canvas></div>
                    </div>
                    <div class="card col-span-6">
                        <div class="card-title mb-4"><i class="fa-solid fa-chart-pie"></i> 品質不良分析</div>
                        <div style="height: 250px; position: relative;"><canvas id="qualityChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="work-orders" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 style="margin:0; font-size:1.2rem;">工單管理系統</h2>
                            <span class="text-sm text-sub">簡易排程與發單 (Lite-ERP)</span>
                        </div>
                        <button class="btn btn-primary" onclick="App.openModal('createWOModal')">
                            <i class="fa-solid fa-plus"></i> 建立新工單
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>工單號</th><th>產品</th><th>進度 (當前/目標)</th><th>優先級</th><th>產線</th><th>狀態</th><th>操作</th></tr></thead>
                            <tbody id="wo-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="fai-system" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 style="margin:0; font-size:1.2rem;">首件檢查 (FAI)</h2>
                        <button class="btn btn-outline" onclick="Swal.fire('Info', '模擬功能', 'info')"><i class="fa-solid fa-gear"></i> 設定</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>工單號</th><th>產品</th><th>版本</th><th>送檢時間</th><th>狀態</th><th>操作</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td><strong>WO-20231220-05</strong></td><td>PCB-Mainboard-X</td>
                                    <td><span class="badge badge-new">Ver 1.2</span></td>
                                    <td>10:30 AM</td>
                                    <td><span class="badge badge-wip">待檢驗</span></td>
                                    <td><button class="btn btn-primary btn-sm" onclick="App.openFAI('WO-20231220-05', 'PCB-Mainboard-X')">開始檢驗</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="inventory" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 style="margin:0; font-size:1.2rem;">物料庫存總覽</h2>
                            <div class="flex gap-2 mt-2">
                                <span class="badge badge-gray cursor-pointer">所有倉庫</span>
                                <span class="badge badge-gray cursor-pointer" style="opacity:0.6">原物料倉</span>
                            </div>
                        </div>
                        <button class="btn btn-outline"><i class="fa-solid fa-rotate"></i> 刷新</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>料號 (Part No.)</th><th>品名</th><th>倉庫位置</th><th>庫存量</th><th>狀態</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td><strong>M-IC-0035</strong></td><td>MCU Controller</td>
                                    <td><i class="fa-solid fa-warehouse text-sub"></i> A01-Shelf-05</td>
                                    <td>1,200 / 500 (Min)</td>
                                    <td><span class="badge badge-done">充足</span></td>
                                </tr>
                                <tr>
                                    <td><strong>M-PCB-1102</strong></td><td>Mainboard V2</td>
                                    <td><i class="fa-solid fa-warehouse text-sub"></i> B02-Zone-C</td>
                                    <td>45 / 100 (Min)</td>
                                    <td><span class="badge badge-alert">低水位</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="quality" class="page-section"><div class="card"><h2>品質管理模組</h2><p class="text-sub">此模組開發中...</p></div></div>
            <div id="engineering" class="page-section"><div class="card"><h2>工藝路徑設定</h2><p class="text-sub">此模組開發中...</p></div></div>

        </main>
    </div>

    <div id="loginModal" class="modal-overlay" style="display: flex;">
        <div class="modal" style="max-width:400px; padding:0;">
            <div class="modal-body text-center" style="padding:40px 30px;">
                <div style="background:var(--sidebar-active); width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                    <i class="fa-solid fa-lock" style="font-size:1.5rem; color:var(--primary);"></i>
                </div>
                <h3 style="margin-bottom:20px;">系統登入</h3>
                <div class="form-group" style="text-align:left;">
                    <label class="form-label">帳號</label>
                    <input type="text" id="loginUser" class="form-control" value="admin" placeholder="Enter username">
                </div>
                <div class="form-group" style="text-align:left;">
                    <label class="form-label">密碼</label>
                    <input type="password" id="loginPass" class="form-control" value="admin123" placeholder="Enter password">
                </div>
                <button onclick="App.login()" class="btn btn-primary w-full" style="justify-content:center; margin-top:10px;">登入</button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0;">設備操作</h3>
                <button onclick="App.closeModal('actionModal')" class="btn-icon btn-ghost"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="App.switchTab('tab-control', this)">監控與控制</div>
                <div class="modal-tab" onclick="App.switchTab('tab-sop', this)">SOP</div>
                <div class="modal-tab" onclick="App.switchTab('tab-repair', this)">維修</div>
            </div>
            <div class="modal-body">
                <div id="tab-control" class="tab-content active">
                    <div class="flex justify-between gap-4 mb-4" style="text-align:center;">
                        <div class="card w-full" style="padding:15px; background:var(--bg-body); box-shadow:none;">
                            <div class="text-sm text-sub">轉速 (RPM)</div>
                            <div class="font-bold" style="font-size:1.5rem;" id="modal-rpm">--</div>
                        </div>
                        <div class="card w-full" style="padding:15px; background:var(--bg-body); box-shadow:none;">
                            <div class="text-sm text-sub">溫度 (Temp)</div>
                            <div class="font-bold" style="font-size:1.5rem; color:var(--success);" id="modal-temp">--</div>
                        </div>
                    </div>
                    <div class="control-grid">
                        <button class="btn-ctrl btn-start" onclick="App.sendCommand('START')"><i class="fa-solid fa-play"></i> 啟動</button>
                        <button class="btn-ctrl btn-stop" onclick="App.sendCommand('STOP')"><i class="fa-solid fa-stop"></i> 停止</button>
                        <button class="btn-ctrl btn-reset" onclick="App.sendCommand('RESET')"><i class="fa-solid fa-rotate-left"></i> 復歸</button>
                    </div>
                </div>
                <div id="tab-sop" class="tab-content">
                    <div style="padding:15px; background:#eff6ff; border-radius:8px; color:#1e40af; margin-bottom:15px; border:1px solid #dbeafe;">
                        <strong><i class="fa-solid fa-circle-info"></i> 操作提示:</strong> 請依照標準程序操作，確保人員安全。
                    </div>
                    <ul style="padding-left:20px; color:var(--text-main);">
                        <li style="margin-bottom:10px;">檢查機台周圍是否有異物。</li>
                        <li style="margin-bottom:10px;">確認緊急停止按鈕處於彈起狀態。</li>
                        <li>按下啟動按鈕前，請先進行蜂鳴器測試。</li>
                    </ul>
                </div>
                <div id="tab-repair" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">異常代碼</label>
                        <select class="form-control"><option>ERR-01 (馬達過熱)</option><option>ERR-02 (感測器異常)</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">備註說明</label>
                        <textarea class="form-control" rows="3"></textarea>
                    </div>
                    <button class="btn btn-danger w-full" style="background:var(--danger); color:white; justify-content:center;" onclick="Swal.fire('已回報', '維修工單已生成', 'success')">提交報修</button>
                </div>
            </div>
        </div>
    </div>

    <div id="faiModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div><h3 style="margin:0;">FAI 首件檢查</h3><div class="text-sm text-sub" id="fai-subtitle"></div></div>
                <button onclick="App.closeModal('faiModal')" class="btn-icon btn-ghost"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body" id="fai-body"></div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="App.clearFAIDraft()">清除暫存</button>
                <button class="btn btn-primary" onclick="App.submitFAI()">提交報告</button>
            </div>
        </div>
    </div>

    <div id="createWOModal" class="modal-overlay">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h3 style="margin:0;">建立生產工單</h3>
                <button onclick="App.closeModal('createWOModal')" class="btn-icon btn-ghost"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">工單編號 (自動)</label>
                    <input type="text" id="new-wo-id" class="form-control" disabled style="background:var(--bg-body); opacity:0.7;">
                </div>
                <div class="form-group">
                    <label class="form-label">產品型號</label>
                    <select id="new-wo-product" class="form-control">
                        <option>PCB-Mainboard-X</option><option>Controller-Gen2</option><option>Power-Supply-Unit</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <div class="form-group w-full">
                        <label class="form-label">目標數量</label>
                        <input type="number" id="new-wo-qty" class="form-control" value="1000">
                    </div>
                    <div class="form-group w-full">
                        <label class="form-label">優先級</label>
                        <select id="new-wo-priority" class="form-control">
                            <option value="Normal">一般</option><option value="High">急件</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">指定產線</label>
                    <select id="new-wo-line" class="form-control">
                        <option value="L1">SMT Line 01</option><option value="L2">DIP Line 01</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="App.closeModal('createWOModal')">取消</button>
                <button class="btn btn-primary" onclick="App.submitNewWO()">確認發布</button>
            </div>
        </div>
    </div>

<script>
    const BASE_URL = 'http://localhost:5289/api';

    const App = {
        data: {
            machines: [],
            wos: [], // 這裡將存儲真實工單
            wipData: [], // 儲存真實 WIP
            faiDraft: {},
            charts: {}
        },
        config: {
            theme: localStorage.getItem('theme') || 'light',
            refreshRate: 3000
        },

        init() {
            this.applyTheme();
            this.checkLogin();
            this.initCharts();

            // Polling
            setInterval(() => {
                if (!document.hidden && localStorage.getItem('mes_token')) {
                    this.fetchData();
                }
            }, this.config.refreshRate);

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) this.fetchData();
            });
        },

        // --- 核心：共用 API 呼叫函式 (DRY 原則) ---
        async apiCall(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('mes_token');
            if (!token && endpoint !== '/Auth/login') return null;

            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            try {
                const config = { method, headers };
                if (body) config.body = JSON.stringify(body);

                const res = await fetch(`${BASE_URL}${endpoint}`, config);

                // 統一處理 401 Token 過期
                if (res.status === 401) {
                    console.warn("Token expired or unauthorized");
                    this.logout();
                    return null;
                }

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.message || `API Error: ${res.status}`);
                }

                // 若是 204 No Content (如 Patch)
                if (res.status === 204) return true;

                return await res.json();

            } catch (error) {
                console.error(`API Call Failed [${endpoint}]:`, error);
                throw error; // 拋出給呼叫者處理 UI
            }
        },

        // --- Authentication ---
        checkLogin() {
            const token = localStorage.getItem('mes_token');
            if (token) {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('logoutBtn').classList.remove('hidden');
                this.fetchData();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        },

        async login() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const btn = document.querySelector('#loginModal .btn-primary');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 驗證中...';
            btn.disabled = true;

            try {
                // 使用共用的 apiCall
                const data = await this.apiCall('/Auth/login', 'POST', { username: u, password: p });
                
                if (data && data.token) {
                    localStorage.setItem('mes_token', data.token);
                    this.checkLogin();
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '登入成功', timer: 1500, showConfirmButton: false });
                }
            } catch (e) {
                Swal.fire('登入失敗', '帳號或密碼錯誤 (或後端未啟動)', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        },

        logout() {
            // 不需詢問直接登出 (如果是 401 觸發)，或保留詢問
            localStorage.removeItem('mes_token');
            location.reload();
        },

        // --- Theme & UI ---
        toggleTheme() {
            this.config.theme = this.config.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', this.config.theme);
            this.applyTheme();
            this.updateChartsTheme();
        },
        applyTheme() {
            document.documentElement.setAttribute('data-theme', this.config.theme);
            const icon = document.getElementById('themeIcon');
            icon.className = this.config.theme === 'light' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        },
        toggleSidebar() {
            document.getElementById('appSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        },
        switchPage(pageId, navEl) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            navEl.classList.add('active');
            if (window.innerWidth <= 768) this.toggleSidebar();
        },

        // --- Core Logic (Data Fetching) ---
        async fetchData() {
            // 平行呼叫 API
            const p1 = this.apiCall('/Equipment');
            const p2 = this.apiCall('/WorkOrder');
            const p3 = this.apiCall('/Production/wip');

            try {
                const [machines, wos, wips] = await Promise.all([p1, p2, p3]);

                if (machines) {
                    this.data.machines = machines.map(m => ({
                        id: m.id,
                        name: m.name,
                        status: m.status,
                        location: m.location,
                        rpm: m.rpm ?? m.RPM ?? 0,
                        temp: m.temperature ?? m.Temperature ?? 0
                    }));
                    this.renderDashboard();
                }

                if (wos) {
                    this.data.wos = wos;
                    this.renderWOs();
                }

                if (wips) {
                    this.data.wipData = wips;
                    this.updateWipChart(wips); // 更新圖表數據
                }

            } catch (e) {
                // apiCall 已經有 log 了，這裡可以忽略
            }
        },

        renderDashboard() {
            const container = document.getElementById('machine-container');
            const statusMap = {
                0: { t: '閒置', c: 'var(--warning)', i: 'fa-pause', bg: 'rgba(245,158,11,0.1)' },
                1: { t: '運轉中', c: 'var(--success)', i: 'fa-gears', bg: 'rgba(16,185,129,0.1)' },
                2: { t: '異常停機', c: 'var(--danger)', i: 'fa-triangle-exclamation', bg: 'rgba(239,68,68,0.1)' },
                3: { t: '維修中', c: 'var(--repair)', i: 'fa-wrench', bg: 'rgba(139,92,246,0.1)' }
            };

            // 如果是初始載入，清空 Skeleton
            if (container.querySelector('.skeleton')) container.innerHTML = '';

            this.data.machines.forEach(m => {
                let card = document.getElementById(`machine-card-${m.id}`);
                const s = statusMap[m.status] || statusMap[0];

                if (card) {
                    // Update existing
                    card.querySelector('.machine-val').innerText = `${m.rpm} RPM | ${m.temp}°C`;
                    const badge = card.querySelector('.badge');
                    badge.innerText = s.t;
                    badge.style.background = s.bg;
                    badge.style.color = s.c;
                    card.style.borderTopColor = s.c;
                    const iconBox = card.querySelector('.icon-box');
                    iconBox.style.background = s.bg;
                    const icon = iconBox.querySelector('i');
                    if (icon.className !== `fa-solid ${s.i}`) {
                        icon.className = `fa-solid ${s.i}`;
                        icon.style.color = s.c;
                    }
                } else {
                    // Create new
                    const html = `
                    <div id="machine-card-${m.id}" class="machine-card" onclick="App.openActionModal(${m.id})" style="border-top-color:${s.c}">
                        <div class="icon-box" style="background:${s.bg}; width:50px; height:50px; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center;">
                            <i class="fa-solid ${s.i}" style="color:${s.c}; font-size:1.5rem;"></i>
                        </div>
                        <div class="machine-name">${m.name}</div>
                        <div class="machine-val">${m.rpm} RPM | ${m.temp}°C</div>
                        <div class="badge" style="margin-top:12px; background:${s.bg}; color:${s.c}">${s.t}</div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                }
            });
        },

        renderWOs() {
            const tbody = document.getElementById('wo-table-body');
            tbody.innerHTML = this.data.wos.map(w => {
                // 計算進度百分比
                const percent = w.targetQty > 0 ? Math.round((w.currentQty / w.targetQty) * 100) : 0;
                // 對應後端的 Status 字串
                let badgeClass = 'badge-new';
                if (w.status === 'Running') badgeClass = 'badge-wip';
                if (w.status === 'Completed') badgeClass = 'badge-done';

                return `
                <tr>
                    <td class="font-bold text-primary">${w.orderNo}</td>
                    <td>${w.product}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div style="flex:1; height:6px; background:var(--border-color); border-radius:3px; overflow:hidden;">
                                <div style="width:${Math.min(100, percent)}%; background:var(--primary); height:100%;"></div>
                            </div>
                            <span class="text-sm">${w.currentQty}/${w.targetQty}</span>
                        </div>
                    </td>
                    <td><span style="color:inherit">Normal</span></td>
                    <td>Default</td>
                    <td><span class="badge ${badgeClass}">${w.status}</span></td>
                    <td>
                        ${w.status === 'New' ? 
                          `<button class="btn btn-primary btn-sm" onclick="App.startWO(${w.id})">開工</button>` : 
                          `<button class="btn btn-ghost btn-icon"><i class="fa-solid fa-ellipsis-vertical"></i></button>`}
                    </td>
                </tr>
            `}).join('');
        },

        // --- Modals & Actions ---
        openModal(id) {
            if (id === 'createWOModal') {
                // 自動帶入日期流水號
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                document.getElementById('new-wo-id').value = `WO-${dateStr}-${String(this.data.wos.length + 1).padStart(3, '0')}`;
            }
            document.getElementById(id).style.display = 'flex';
        },
        closeModal(id) { document.getElementById(id).style.display = 'none'; },

        openActionModal(machineId) {
            const m = this.data.machines.find(x => x.id === machineId);
            if (!m) return;
            this.currentMachine = m; // 存起來供操作使用
            document.getElementById('modalTitle').innerText = `${m.name} - 控制台`;
            document.getElementById('modal-rpm').innerText = m.rpm;
            document.getElementById('modal-temp').innerText = m.temp + '°C';
            this.openModal('actionModal');
        },

        switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        },

        // --- CRUD Actions ---
        
        // 1. 建立工單 (POST)
        async submitNewWO() {
            const dto = {
                orderNo: document.getElementById('new-wo-id').value,
                product: document.getElementById('new-wo-product').value,
                targetQty: parseInt(document.getElementById('new-wo-qty').value) || 0
            };

            try {
                await this.apiCall('/WorkOrder', 'POST', dto);
                this.closeModal('createWOModal');
                Swal.fire('建立成功', `工單 ${dto.orderNo} 已發布`, 'success');
                this.fetchData(); // 重新撈取列表
            } catch (e) {
                Swal.fire('建立失敗', e.message, 'error');
            }
        },

        // 2. 開工 (PATCH)
        async startWO(id) {
            try {
                await this.apiCall(`/WorkOrder/${id}/start`, 'PATCH');
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: '工單已開工', timer: 1500, showConfirmButton: false });
                this.fetchData();
            } catch (e) {
                Swal.fire('操作失敗', e.message, 'error');
            }
        },

        // 3. 設備報修/更新
        async submitAction() {
            // 這裡您可以根據需要呼叫 PATCH /Maintenance 相關 API
            // 目前維持前端模擬，或您可自行串接 Day 14 的 API
            this.closeModal('actionModal');
            Swal.fire('指令已發送', '', 'success');
        },
        
        async sendCommand(cmd) {
             const res = await Swal.fire({ title: `執行 ${cmd}?`, icon: 'warning', showCancelButton: true });
             if(res.isConfirmed) Swal.fire('指令已發送', '', 'success');
        },

        updateContext() {
            // 模擬切換產線 Loading
            document.getElementById('machine-container').innerHTML = Array(4).fill('<div class="skeleton" style="height:150px;"></div>').join('');
            setTimeout(() => this.fetchData(), 500);
        },

        // --- FAI (模擬) ---
        openFAI(wo, prod) { /* ... 保持原樣 ... */ },
        setFAI(id, status) { /* ... 保持原樣 ... */ },
        setFAIRemark(id, val) { /* ... 保持原樣 ... */ },
        submitFAI() { /* ... 保持原樣 ... */ },
        clearFAIDraft() { /* ... 保持原樣 ... */ },

        // --- Charts & Visualization (數據聚合) ---
        initCharts() {
            const ctx1 = document.getElementById('wipChart').getContext('2d');
            const ctx2 = document.getElementById('qualityChart').getContext('2d');

            this.data.charts.wip = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: [], // 動態載入
                    datasets: [{ label: 'WIP Qty', data: [], backgroundColor: '#3b82f6', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#e2e8f0' } } } }
            });

            // Quality Chart 暫時保持靜態，後端尚未有品質資料 API
            this.data.charts.quality = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Pass', 'Fail'],
                    datasets: [{ data: [96, 4], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        },

        // [Day 19] 更新 WIP 圖表：將後端明細資料聚合為圖表數據
        updateWipChart(wipList) {
            if (!this.data.charts.wip) return;

            // 1. Data Aggregation (聚合): 加總每個站點的數量
            // 格式: { "SMT": 120, "AOI": 50 }
            const aggregated = {};
            wipList.forEach(w => {
                // 如果後端沒回傳 StationName，就用 ID 代替
                const key = w.stationName || `Station ${w.stationId}`;
                aggregated[key] = (aggregated[key] || 0) + w.quantity;
            });

            // 2. 轉換為 Chart.js 格式
            const labels = Object.keys(aggregated);
            const data = Object.values(aggregated);

            // 3. 更新圖表
            const chart = this.data.charts.wip;
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        },

        updateChartsTheme() { /* ... 保持原樣 ... */ }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>