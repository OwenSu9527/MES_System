<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES æ™ºæ…§æˆ°æƒ…å®¤</title>
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --repair: #3b82f6; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        h1 { text-align: center; margin-bottom: 30px; font-weight: 800; color: #111827; }
        
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .section-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--primary); padding-left: 10px; }

        /* æ©Ÿå°åˆ—è¡¨ */
        .machine-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .machine-card { 
            text-align: center; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .machine-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
        .machine-card::after { content: 'ğŸ‘† é»æ“Šæ“ä½œ'; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.05); font-size: 0.8rem; color: #666; padding: 2px 0; opacity: 0; transition: opacity 0.2s; }
        .machine-card:hover::after { opacity: 1; }

        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 99px; font-size: 0.875rem; font-weight: 600; margin-top: 10px; color: white;}
        .status-0 { background-color: var(--warning); } /* Idle */
        .status-1 { background-color: var(--success); } /* Running */
        .status-2 { background-color: var(--danger); }  /* Down */
        .status-3 { background-color: var(--repair); }  /* Repair (Day 15 æ–°å¢) */

        /* æ¨¡æ…‹è¦–çª— (Modal) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal h3 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #e5e7eb; color: #374151; }
        .btn-submit { background: var(--primary); color: white; }
        .btn-submit:hover { opacity: 0.9; }

        /* å…¶ä»–åŸæœ‰æ¨£å¼ (å·¥å–®/WIP) */
        .wo-list { display: flex; flex-direction: column; gap: 10px; }
        .wo-item { border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .progress-bg { background-color: #e5e7eb; border-radius: 99px; height: 10px; width: 100%; margin-top: 5px; overflow: hidden; }
        .progress-bar { background-color: var(--primary); height: 100%; transition: width 0.5s ease; }
        .wip-chart { display: flex; align-items: flex-end; gap: 20px; height: 150px; padding-top: 20px; border-bottom: 2px solid #ccc;}
        .bar-container { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; }
        .bar { background-color: var(--warning); width: 60%; margin: 0 auto; border-radius: 5px 5px 0 0; transition: height 0.5s; min-height: 2px; }
    </style>
</head>
<body>

    <h1>ğŸ­ MES æ™ºæ…§è£½é€ æˆ°æƒ…å®¤</h1>

    <div class="container">
        <div class="card">
            <div class="section-title">è¨­å‚™ç‹€æ…‹ç›£æ§ (é»æ“Šå¯æ“ä½œ)</div>
            <div id="machine-container" class="machine-grid">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card">
            <div class="section-title">ç”Ÿç”¢å·¥å–®é€²åº¦</div>
            <div id="wo-container" class="wo-list">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card">
            <div class="section-title">ç”¢ç·šåœ¨è£½å“å †ç©</div>
            <div id="wip-container" class="wip-chart">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="actionModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">è¨­å‚™æ“ä½œ</h3>
            <div id="modalContent">
                </div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-submit" onclick="submitAction()">ç¢ºå®šåŸ·è¡Œ</button>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š API åŸºç¤ç¶²å€ (è«‹ä¾æ“šæ‚¨çš„ Swagger Port ä¿®æ”¹)
        const BASE_URL = 'http://localhost:5289/api';

        // ç•¶å‰æ“ä½œçš„æ©Ÿå°è³‡æ–™
        let currentMachine = null;

        // å•Ÿå‹•
        fetchData();
        setInterval(fetchData, 5000);

        async function fetchData() {
            try {
                const [eqRes, woRes, wipRes] = await Promise.all([
                    fetch(`${BASE_URL}/Equipment`),
                    fetch(`${BASE_URL}/WorkOrder`),
                    fetch(`${BASE_URL}/Production/wip`)
                ]);
                
                renderMachines(await eqRes.json());
                renderWorkOrders(await woRes.json());
                renderWip(await wipRes.json());
            } catch (error) { console.error("Fetch Error:", error); }
        }

        // æ¸²æŸ“æ©Ÿå°
        function renderMachines(data) {
            const container = document.getElementById('machine-container');
            const statusText = { 0: 'é–’ç½® Idle', 1: 'é‹ä½œ Running', 2: 'æ•…éšœ Down', 3: 'ç¶­ä¿® Repair' };
            
            container.innerHTML = data.map(eq => `
                <div class="machine-card" onclick='openActionModal(${JSON.stringify(eq)})'>
                    <div style="font-weight:bold; font-size:1.1rem;">${eq.name}</div>
                    <div style="font-size:0.9rem; color:#666; margin:5px 0;">${eq.location}</div>
                    <div class="status-badge status-${eq.status}">
                        ${statusText[eq.status] || 'Unknown'}
                    </div>
                </div>
            `).join('');
        }

        // é–‹å•Ÿæ“ä½œè¦–çª— (æ ¸å¿ƒé‚è¼¯)
        function openActionModal(eq) {
            currentMachine = eq;
            const modal = document.getElementById('actionModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            modal.style.display = 'flex';
            title.innerText = `æ“ä½œè¨­å‚™: ${eq.name}`;

            // æ ¹æ“šæ©Ÿå°ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸åŒçš„è¡¨å–®
            if (eq.status === 1 || eq.status === 0) { 
                // Running/Idle -> å¯ä»¥å ±ä¿®
                content.innerHTML = `
                    <p>ç›®å‰ç‹€æ…‹æ­£å¸¸ã€‚æ˜¯å¦è¦å›å ±ç•°å¸¸ï¼Ÿ</p>
                    <div class="form-group">
                        <label>ç•°å¸¸ä»£ç¢¼ (Reason Code)</label>
                        <input type="text" id="inputReason" value="ERR-001">
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <textarea id="inputDesc">é‹è½‰ç•°éŸ³</textarea>
                    </div>
                    <input type="hidden" id="actionType" value="REPORT">
                `;
            } else if (eq.status === 2) {
                // Down -> å¯ä»¥é–‹å§‹ç¶­ä¿®
                // æ³¨æ„ï¼šé€™è£¡æ‡‰è©²è¦æŸ¥è©¢ RequestIdï¼Œä½†ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆå‡è¨­ç³»çµ±æœƒè‡ªå‹•æŠ“æœ€æ–°çš„ä¸€å¼µ Open å–®
                // å¯¦å‹™ä¸Šéœ€è¦å…ˆ GET /Maintenance/open-list
                content.innerHTML = `
                    <p style="color:red; font-weight:bold;">è¨­å‚™æ•…éšœä¸­ï¼</p>
                    <p>ç¶­ä¿®å·¥ç¨‹å¸«å·²åˆ°å ´ï¼Œè¦é–‹å§‹ç¶­ä¿®å—ï¼Ÿ</p>
                    <div class="form-group">
                        <label>ç¶­ä¿®å–® ID (æ¨¡æ“¬è¼¸å…¥)</label>
                        <input type="number" id="inputRequestId" placeholder="è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ">
                        <small style="color:#666">è«‹å…ˆæŸ¥çœ‹ DB æˆ–ç”±ç³»çµ±è‡ªå‹•å¸¶å…¥</small>
                    </div>
                    <input type="hidden" id="actionType" value="START">
                `;
            } else if (eq.status === 3) {
                // Repair -> å¯ä»¥å®Œä¿®
                content.innerHTML = `
                    <p style="color:blue; font-weight:bold;">è¨­å‚™ç¶­ä¿®ä¸­...</p>
                    <div class="form-group">
                        <label>ç¶­ä¿®å–® ID (æ¨¡æ“¬è¼¸å…¥)</label>
                        <input type="number" id="inputRequestId" placeholder="è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label>è™•ç½®å°ç­–</label>
                        <textarea id="inputSolution">æ›´æ›é›¶ä»¶</textarea>
                    </div>
                    <input type="hidden" id="actionType" value="COMPLETE">
                `;
            }
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        // é€å‡ºè¡¨å–® (å‘¼å« API)
        async function submitAction() {
            const type = document.getElementById('actionType').value;
            let url = '', method = '', body = {};

            try {
                if (type === 'REPORT') {
                    url = `${BASE_URL}/Maintenance/request`;
                    method = 'POST';
                    body = {
                        equipmentId: currentMachine.id,
                        requestUser: "Dashboard User",
                        reasonCode: document.getElementById('inputReason').value,
                        description: document.getElementById('inputDesc').value
                    };
                } else if (type === 'START') {
                    const reqId = document.getElementById('inputRequestId').value;
                    if(!reqId) return alert('è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ');
                    url = `${BASE_URL}/Maintenance/${reqId}/start`;
                    method = 'PATCH';
                } else if (type === 'COMPLETE') {
                    const reqId = document.getElementById('inputRequestId').value;
                    if(!reqId) return alert('è«‹è¼¸å…¥ç¶­ä¿®å–®è™Ÿ');
                    url = `${BASE_URL}/Maintenance/complete`;
                    method = 'POST';
                    body = {
                        requestId: reqId,
                        solution: document.getElementById('inputSolution').value,
                        remark: "Dashboard Completed"
                    };
                }

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: method === 'POST' ? JSON.stringify(body) : null
                });

                if (res.ok) {
                    alert('æ“ä½œæˆåŠŸï¼');
                    closeModal();
                    fetchData(); // ç«‹å³æ›´æ–°ç•«é¢
                } else {
                    const err = await res.json();
                    alert('å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
                }

            } catch (e) {
                alert('é€£ç·šéŒ¯èª¤');
                console.error(e);
            }
        }

        // (æ¸²æŸ“å·¥å–®å’Œ WIP çš„å‡½å¼ä¿æŒä¸è®Šï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹ä¿ç•™æ‚¨åŸæœ¬çš„ç¨‹å¼ç¢¼)
        function renderWorkOrders(data) { /* ...è²¼ä¸ŠåŸæœ¬çš„ç¨‹å¼ç¢¼... */ 
             const container = document.getElementById('wo-container');
            const activeOrders = data.filter(o => o.status !== 'Completed');
            if (activeOrders.length === 0) {
                container.innerHTML = '<div style="color:#666;">ç›®å‰ç„¡ç”Ÿç”¢ä¸­å·¥å–®</div>';
                return;
            }
            container.innerHTML = activeOrders.map(wo => {
                const percent = wo.targetQty > 0 ? Math.min(100, Math.round((wo.currentQty / wo.targetQty) * 100)) : 0;
                return `
                <div class="wo-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>${wo.orderNo} (${wo.product})</strong>
                        <span>${wo.currentQty} / ${wo.targetQty} (${wo.status})</span>
                    </div>
                    <div class="progress-bg"><div class="progress-bar" style="width: ${percent}%"></div></div>
                </div>`}).join('');
        }
        
        function renderWip(data) { /* ...è²¼ä¸ŠåŸæœ¬çš„ç¨‹å¼ç¢¼... */ 
            const container = document.getElementById('wip-container');
            const stationMap = {};
            data.forEach(w => { const name = w.stationName || `Station ${w.stationId}`; stationMap[name] = (stationMap[name] || 0) + w.quantity; });
            const html = Object.keys(stationMap).map(stationName => {
                const qty = stationMap[stationName];
                const heightPercent = Math.min(100, (qty / 500) * 100); 
                return `<div class="bar-container"><div class="bar-value">${qty}</div><div class="bar" style="height: ${heightPercent}%;"></div><div class="bar-label">${stationName}</div></div>`;
            }).join('');
            container.innerHTML = html || '<div style="width:100%; text-align:center;">å°šç„¡ WIP è³‡æ–™</div>';
        }
    </script>
</body>
</html>