<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES æ™ºæ…§æˆ°æƒ…å®¤</title>
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        h1 { text-align: center; margin-bottom: 30px; font-weight: 800; color: #111827; }
        
        /* ä½ˆå±€å®¹å™¨ */
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 20px; }
        
        /* å€å¡Šæ¨™é¡Œ */
        .section-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--primary); padding-left: 10px; }

        /* å¡ç‰‡å…±ç”¨æ¨£å¼ */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        /* æ©Ÿå°ç›£æ§å€ (Grid) */
        .machine-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .machine-card { text-align: center; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 99px; font-size: 0.875rem; font-weight: 600; margin-top: 10px; color: white;}
        .status-0 { background-color: var(--warning); } /* Idle */
        .status-1 { background-color: var(--success); } /* Running */
        .status-2 { background-color: var(--danger); }  /* Down */
		/* [Day 14 ä¿®æ­£] è£œä¸Šç¶­ä¿®ç‹€æ…‹çš„è—è‰² */
        .status-3 { background-color: #3b82f6; }        /* Repair */

        /* å·¥å–®åˆ—è¡¨å€ */
        .wo-list { display: flex; flex-direction: column; gap: 10px; }
        .wo-item { border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .progress-bg { background-color: #e5e7eb; border-radius: 99px; height: 10px; width: 100%; margin-top: 5px; overflow: hidden; }
        .progress-bar { background-color: var(--primary); height: 100%; transition: width 0.5s ease; }
        
        /* WIP åœ–è¡¨å€ (ç°¡å–®çš„é•·æ¢åœ–) */
        .wip-chart { display: flex; align-items: flex-end; gap: 20px; height: 200px; padding-top: 20px; border-bottom: 2px solid #ccc;}
        .bar-container { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; }
        .bar { background-color: var(--warning); width: 60%; margin: 0 auto; border-radius: 5px 5px 0 0; transition: height 0.5s; min-height: 2px; }
        .bar-label { margin-top: 5px; font-weight: bold; font-size: 0.9rem; }
        .bar-value { margin-bottom: 5px; font-weight: bold; }

    </style>
</head>
<body>

    <h1>ğŸ­ MES æ™ºæ…§è£½é€ æˆ°æƒ…å®¤</h1>

    <div class="container">
        
        <div class="card">
            <div class="section-title">è¨­å‚™ç‹€æ…‹ç›£æ§ (Equipment Status)</div>
            <div id="machine-container" class="machine-grid">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card">
            <div class="section-title">ç”Ÿç”¢å·¥å–®é€²åº¦ (Active Work Orders)</div>
            <div id="wo-container" class="wo-list">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card">
            <div class="section-title">ç”¢ç·šåœ¨è£½å“å †ç© (WIP Level)</div>
            <div id="wip-container" class="wip-chart">è¼‰å…¥ä¸­...</div>
        </div>

    </div>

    <script>
        // è¨­å®š API åŸºç¤ç¶²å€ (è«‹ä¾æ“šæ‚¨çš„ Swagger Port ä¿®æ”¹)
        const BASE_URL = 'http://localhost:5289/api';

        // å•Ÿå‹•è‡ªå‹•æ›´æ–°
        fetchData();
        setInterval(fetchData, 5000); // æ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡

        async function fetchData() {
            try {
                // å¹³è¡Œå‘¼å«ä¸‰æ”¯ API
                const [eqRes, woRes, wipRes] = await Promise.all([
                    fetch(`${BASE_URL}/Equipment`),
                    fetch(`${BASE_URL}/WorkOrder`),
                    fetch(`${BASE_URL}/Production/wip`)
                ]);

                const equipments = await eqRes.json();
                const workOrders = await woRes.json();
                const wips = await wipRes.json();

                renderMachines(equipments);
                renderWorkOrders(workOrders);
                renderWip(wips);

            } catch (error) {
                console.error("Data Fetch Error:", error);
            }
        }

        // æ¸²æŸ“æ©Ÿå°
        function renderMachines(data) {
            const container = document.getElementById('machine-container');
            const statusText = { 0: 'é–’ç½® Idle', 1: 'é‹ä½œ Running', 2: 'æ•…éšœ Down', 3: 'ç¶­ä¿® Repair' };
            
            container.innerHTML = data.map(eq => `
                <div class="machine-card">
                    <div style="font-weight:bold; font-size:1.1rem;">${eq.name}</div>
                    <div class="status-badge status-${eq.status}">
                        ${statusText[eq.status] || 'Unknown'}
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“å·¥å–®
        function renderWorkOrders(data) {
            const container = document.getElementById('wo-container');
            // åªé¡¯ç¤º New æˆ– Running çš„å·¥å–®
            const activeOrders = data.filter(o => o.status !== 'Completed');

            if (activeOrders.length === 0) {
                container.innerHTML = '<div style="color:#666;">ç›®å‰ç„¡ç”Ÿç”¢ä¸­å·¥å–®</div>';
                return;
            }

            container.innerHTML = activeOrders.map(wo => {
                const percent = Math.min(100, Math.round((wo.currentQty / wo.targetQty) * 100));
                return `
                <div class="wo-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>${wo.orderNo} (${wo.product})</strong>
                        <span>${wo.currentQty} / ${wo.targetQty} (${wo.status})</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-bar" style="width: ${percent}%"></div>
                    </div>
                </div>
            `}).join('');
        }

        // æ¸²æŸ“ WIP åœ–è¡¨
        function renderWip(data) {
            const container = document.getElementById('wip-container');
            
            // ç°¡å–®èšåˆï¼šæŠŠç›¸åŒ StationId çš„æ•¸é‡åŠ ç¸½ (é›–ç„¶ç›®å‰æˆ‘å€‘è³‡æ–™åº«çµæ§‹ä¸€å€‹ç«™é»ä¸€å¼µå–®å¯èƒ½æœ‰å¤šç­†ï¼Œé€™è£¡ç°¡åŒ–é¡¯ç¤º)
            // å¯¦å‹™ä¸Šæ‡‰è©²ç”±å¾Œç«¯ GroupByï¼Œé€™è£¡ç¤ºç¯„å‰ç«¯è™•ç†
            const stationMap = {};
            data.forEach(w => {
                // å¦‚æœ StationName æ²’å­˜ï¼Œå°±ç”¨ ID ä»£æ›¿
                const name = w.stationName || `Station ${w.stationId}`;
                stationMap[name] = (stationMap[name] || 0) + w.quantity;
            });

            const html = Object.keys(stationMap).map(stationName => {
                const qty = stationMap[stationName];
                // å‡è¨­æœ€å¤§é«˜åº¦å°æ‡‰ 500 å€‹ï¼Œè¨ˆç®—ç™¾åˆ†æ¯”é«˜åº¦
                const heightPercent = Math.min(100, (qty / 500) * 100); 
                return `
                <div class="bar-container">
                    <div class="bar-value">${qty}</div>
                    <div class="bar" style="height: ${heightPercent}%;"></div>
                    <div class="bar-label">${stationName}</div>
                </div>
                `;
            }).join('');

            container.innerHTML = html || '<div style="width:100%; text-align:center;">å°šç„¡ WIP è³‡æ–™</div>';
        }
    </script>
</body>
</html>